<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Futuristic J.A.R.V.I.S Interface with Advanced Chat</title>
  <!-- Import Inconsolata Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
  <!-- Import Font Awesome for the microphone icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" 
    integrity="sha512-papXtj68WQRnoZlRm0HOVZPbMJsfH4a0xuY0mXkRn9tg4LtX8/EP8vbdqwQl1Z7zOZrmFervaHEaahGQG+D9ug=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Global resets & background */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: 'Inconsolata', monospace;
      background-color: #000;
      background-image: repeating-linear-gradient(
          0deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 1px, transparent 1px, transparent 20px),
        repeating-linear-gradient(
          90deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 1px, transparent 1px, transparent 20px);
      background-size: 20px 20px;
      color: #fff;
    }
    /* Particle background container */
    #particles-js {
      position: absolute;
      width: 100%;
      height: 100%;
      z-index: -2;
    }
    /* Main UI Container (Grid background) */
    #grid-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: transparent;
    }
    /* Boot Button styling */
    #boot-btn {
      background-color: transparent;
      border: 3px solid #fff;
      color: #fff;
      font-size: 1.5rem;
      padding: 1.5rem;
      border-radius: 50%;
      cursor: pointer;
      transition: opacity 1s ease;
      width: 200px;
      height: 200px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2;
    }
    #boot-btn.fade-out {
      opacity: 0;
    }
    /* Boot Sequence Container */
    #boot-sequence {
      display: none;
      width: 0;
      max-width: 500px;
      transition: width 2s ease;
      margin: 20px 0;
      text-align: left;
      z-index: 2;
    }
    #progress-percentage {
      font-size: 1rem;
      text-align: right;
      width: 100%;
      margin-bottom: 5px;
    }
    #progress-container {
      width: 100%;
      height: 20px;
      border: 1px solid #fff;
      margin-bottom: 10px;
      overflow: hidden;
    }
    #progress-bar {
      width: 0%;
      height: 100%;
      background-color: #fff;
      transition: width 0.05s linear;
    }
    #terminal-output {
      font-size: 1rem;
      background-color: #000;
      padding: 10px;
      border: 1px solid #fff;
      min-height: 80px;
    }
    /* Banner-style J.A.R.V.I.S Title & Typewriter */
    #jarvisTitle {
      display: none;
      font-size: calc(4rem + 5vw);
      text-shadow: 4px 4px 0 #000;
      margin: 20px 0;
      z-index: 2;
    }
    #typewriter {
      display: inline-block;
      overflow: hidden;
      white-space: nowrap;
      border-right: 2px solid #fff;
      width: 0;
    }
    #typewriter.animate {
      animation: typing 3s steps(11, end) forwards;
    }
    @keyframes typing {
      from { width: 0; }
      to { width: 11ch; }
    }
    /* Info Box (top-right) */
    #info-box {
      position: absolute;
      top: 20px;
      right: 20px;
      display: none;
      opacity: 0;
      width: 250px;
      padding: 20px;
      background-color: rgba(255,255,255,0.1);
      border: 1px solid #fff;
      border-radius: 15px;
      transition: opacity 1s ease, transform 1s ease;
      transform: scale(0.9);
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      z-index: 3;
    }
    #info-box.visible {
      opacity: 1;
      transform: scale(1);
    }
    .info-header {
      position: absolute;
      top: 5px;
      right: 10px;
      font-size: 0.8rem;
    }
    /* Red Microphone Button */
    #mic-button {
      position: fixed;
      bottom: 20px;
      left: calc(50% - 30px);
      width: 60px;
      height: 60px;
      background-color: #e74c3c;
      border: none;
      border-radius: 50%;
      color: #fff;
      font-size: 1.5rem;
      display: none;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 3;
    }
    /* Chat UI Styling */
    #chat-ui {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #111;
      color: #fff;
      font-family: 'Inconsolata', monospace;
      z-index: 10;
      flex-direction: column;
    }
    #chat-header {
      padding: 20px;
      background-color: #222;
      font-size: 1.5rem;
      text-align: center;
    }
    #chat-conversation {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    /* Chat message bubbles (larger text, rounded boxes) */
    .chat-message {
      max-width: 70%;
      margin: 10px 5px;
      padding: 15px;
      font-size: 1.5rem;
      border-radius: 15px;
      word-wrap: break-word;
    }
    .chat-message.ai {
      background-color: #444;
      align-self: flex-start;
    }
    .chat-message.user {
      background-color: #2ecc71;
      align-self: flex-end;
    }
    #chat-input-container {
      padding: 10px;
      background-color: #222;
      display: flex;
    }
    #chat-input {
      flex: 1;
      padding: 10px;
      font-size: 1rem;
      border: none;
      outline: none;
    }
    #chat-send {
      padding: 10px 20px;
      background-color: #e74c3c;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      color: #fff;
    }
  </style>
</head>
<body>
  <!-- Particle Background Container -->
  <div id="particles-js"></div>
  
  <!-- Main UI Container (Grid Background) -->
  <div id="grid-container">
    <!-- Boot Button -->
    <button id="boot-btn">BOOT J.A.R.V.I.S</button>
    
    <!-- Boot Sequence Container -->
    <div id="boot-sequence">
      <div id="progress-percentage">0%</div>
      <div id="progress-container">
        <div id="progress-bar"></div>
      </div>
      <div id="terminal-output"></div>
    </div>
    
    <!-- Banner-style J.A.R.V.I.S Title -->
    <h1 id="jarvisTitle">
      <span id="typewriter">J.A.R.V.I.S</span>
    </h1>
    
    <!-- Info Box -->
    <div id="info-box">
      <div class="info-header">
        <span id="sync-text">SYNCED</span>
      </div>
      <div class="info-content">
        <div id="date"></div>
        <div id="time"></div>
        <div id="weather"></div>
      </div>
    </div>
  </div>
  
  <!-- Red Microphone Button -->
  <button id="mic-button"><i class="fas fa-microphone"></i></button>
  
  <!-- Chat UI for conversation with Jarvis -->
  <div id="chat-ui">
    <div id="chat-header">J.A.R.V.I.S Chat</div>
    <div id="chat-conversation"></div>
    <div id="chat-input-container">
      <input type="text" id="chat-input" placeholder="Type your message...">
      <button id="chat-send">Send</button>
    </div>
  </div>
  
  <!-- Scripts -->
  <!-- Include particles.js -->
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
  <script>
    // Initialize particles.js with a sample configuration.
    particlesJS("particles-js", {
      "particles": {
        "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
        "color": { "value": "#ffffff" },
        "shape": { "type": "circle", "stroke": { "width": 0, "color": "#000000" }, "polygon": { "nb_sides": 5 } },
        "opacity": { "value": 0.5, "random": false },
        "size": { "value": 3, "random": true },
        "line_linked": { "enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.4, "width": 1 },
        "move": { "enable": true, "speed": 6, "direction": "none", "random": false, "straight": false, "out_mode": "out" }
      },
      "interactivity": {
        "detect_on": "canvas",
        "events": { "onhover": { "enable": true, "mode": "repulse" }, "onclick": { "enable": true, "mode": "push" }, "resize": true },
        "modes": { "repulse": { "distance": 200 } }
      },
      "retina_detect": true
    });
    
    // Logging function - logs events exclusively to the console.
    function logEvent(message, type) {
      const timeStamp = new Date().toLocaleTimeString();
      if (type === "error") {
        console.error(timeStamp + " - " + message);
      } else {
        console.log(timeStamp + " - " + message);
      }
    }
    
    // --- Chat-specific AI request function ---
    // Replace '/api/chat' with your actual AI endpoint.
    async function getJarvisResponseFromAPI(userMessage) {
      try {
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ message: userMessage })
        });
        if (!response.ok) {
          throw new Error("API response was not ok");
        }
        const data = await response.json();
        // Expect data.response to contain the AI's reply.
        return data.response;
      } catch (err) {
        logEvent("AI API Error: " + err, "error");
        return "I'm sorry, I encountered an error while processing your request.";
      }
    }
    
    document.addEventListener("DOMContentLoaded", function () {
      const bootBtn = document.getElementById("boot-btn");
      const bootSequence = document.getElementById("boot-sequence");
      const progressBar = document.getElementById("progress-bar");
      const progressPercentage = document.getElementById("progress-percentage");
      const terminalOutput = document.getElementById("terminal-output");
      const jarvisTitle = document.getElementById("jarvisTitle");
      const typewriter = document.getElementById("typewriter");
      const micButton = document.getElementById("mic-button");
      const chatUI = document.getElementById("chat-ui");
      const chatConversation = document.getElementById("chat-conversation");
      const chatInput = document.getElementById("chat-input");
      const chatSend = document.getElementById("chat-send");
      
      logEvent("Page loaded. Awaiting user action.");
      
      bootBtn.addEventListener("click", function () {
        logEvent("Boot button clicked.");
        bootBtn.classList.add("fade-out");
        setTimeout(function () {
          logEvent("Boot button faded out.");
          bootBtn.style.display = "none";
          
          // Display and expand the boot sequence container.
          bootSequence.style.display = "block";
          logEvent("Boot sequence container displayed. Expanding...");
          bootSequence.style.width = "0";
          setTimeout(function () {
            bootSequence.style.width = "80%";
            logEvent("Boot sequence container expanding to 80% width.");
          }, 50);
          
          // Start progress simulation.
          setTimeout(function () {
            logEvent("Starting progress simulation over 10 seconds.");
            simulateProgress(10000);
          }, 2050);
        }, 1000);
      });
      
      // Simulate progress with terminal updates.
      function simulateProgress(duration) {
        const updates = [
          { threshold: 10, message: ">> Initializing core systems...", printed: false },
          { threshold: 20, message: ">> Loading modules...", printed: false },
          { threshold: 40, message: ">> Accessing secure memory...", printed: false },
          { threshold: 50, message: ">> Loading neural network architecture...", printed: false },
          { threshold: 65, message: ">> Verifying system integrity...", printed: false },
          { threshold: 80, message: ">> Calibrating sensors and processors...", printed: false },
          { threshold: 90, message: ">> Initiating self-diagnostics...", printed: false },
          { threshold: 100, message: ">> Boot sequence complete.", printed: false }
        ];
        
        const startTime = Date.now();
        const timer = setInterval(function () {
          const elapsed = Date.now() - startTime;
          let percent = Math.min((elapsed / duration) * 100, 100);
          percent = Math.floor(percent);
          
          progressPercentage.innerText = percent + "%";
          progressBar.style.width = percent + "%";
          
          updates.forEach(update => {
            if (!update.printed && percent >= update.threshold) {
              terminalOutput.innerHTML += update.message + "<br>";
              logEvent("Progress reached " + percent + "%: " + update.message);
              update.printed = true;
            }
          });
          
          if (percent >= 100) {
            clearInterval(timer);
            logEvent("Progress simulation complete.");
            setTimeout(function () {
              bootSequence.style.display = "none";
              logEvent("Boot sequence container hidden.");
              jarvisTitle.style.display = "block";
              logEvent("J.A.R.V.I.S title displayed. Starting typewriter animation.");
              typewriter.classList.add("animate");
            }, 1000);
          }
        }, 50);
      }
      
      // After the typewriter animation, remove the caret and show the info box and microphone button.
      typewriter.addEventListener("animationend", function () {
        typewriter.style.borderRight = "none";
        logEvent("Typewriter animation complete.");
        setTimeout(function () {
          showInfoBox();
          showMicButton();
        }, 1000);
      });
      
      function showInfoBox() {
        const infoBox = document.getElementById("info-box");
        infoBox.style.display = "flex";
        setTimeout(function () {
          infoBox.classList.add("visible");
          logEvent("Info box displayed and faded in.");
        }, 50);
        updateDateTime();
        setInterval(updateDateTime, 1000);
        updateWeather();
        setInterval(updateWeather, 60000);
      }
      
      function showMicButton() {
        micButton.style.display = "flex";
        logEvent("Microphone button displayed.");
      }
      
      // Transition to Chat UI when microphone button is clicked.
      micButton.addEventListener("click", function () {
        logEvent("Microphone button clicked. Transitioning to Chat UI.");
        document.getElementById("grid-container").style.display = "none";
        micButton.style.display = "none";
        chatUI.style.display = "flex";
      });
      
      // Chat UI: send message when button is clicked or Enter is pressed.
      chatSend.addEventListener("click", async function () {
        await sendChatMessage();
      });
      chatInput.addEventListener("keypress", async function (e) {
        if (e.key === "Enter") {
          await sendChatMessage();
        }
      });
      
      // Append chat message bubbles.
      function appendChatMessage(sender, text) {
        const messageElem = document.createElement("div");
        messageElem.classList.add("chat-message");
        if (sender.toLowerCase() === "jarvis") {
          messageElem.classList.add("ai");
        } else {
          messageElem.classList.add("user");
        }
        messageElem.innerText = text;
        chatConversation.appendChild(messageElem);
        chatConversation.scrollTop = chatConversation.scrollHeight;
      }
      
      // Send chat message and fetch AI response from the real AI endpoint.
      async function sendChatMessage() {
        const message = chatInput.value.trim();
        if (message !== "") {
          appendChatMessage("You", message);
          chatInput.value = "";
          // Call the actual AI endpoint to get Jarvis's intelligent response.
          const responseText = await getJarvisResponseFromAPI(message);
          appendChatMessage("Jarvis", responseText);
        }
      }
      
      // Update date and time in the info box.
      function updateDateTime() {
        const now = new Date();
        document.getElementById("date").innerText = now.toLocaleDateString();
        document.getElementById("time").innerText = now.toLocaleTimeString();
      }
      
      // Update weather using native geolocation (with fallback via IP-based geolocation).
      function updateWeather() {
        if (navigator.geolocation) {
          logEvent("Requesting geolocation...");
          navigator.geolocation.getCurrentPosition(
            position => {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              logEvent("Geolocation obtained: (" + lat.toFixed(3) + ", " + lon.toFixed(3) + "). Reverse geocoding...");
              fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`)
                .then(response => response.json())
                .then(geoData => {
                  const city = geoData.address.city || geoData.address.town || geoData.address.village || geoData.address.hamlet || "Unknown";
                  logEvent("Reverse geocoding result: " + city);
                  const url = `https://wttr.in/@${encodeURIComponent(city)}?format=j1`;
                  logEvent("Querying weather for " + city + " using URL: " + url);
                  return fetch(url)
                    .then(response => response.json())
                    .then(data => {
                      const temp = data.current_condition[0].temp_C;
                      const description = data.current_condition[0].weatherDesc[0].value;
                      document.getElementById("weather").innerText = `${city} | ${temp}째C, ${description}`;
                      logEvent("Weather updated: " + `${city} | ${temp}째C, ${description}`);
                    });
                })
                .catch(err => {
                  document.getElementById("weather").innerText = "Weather data unavailable";
                  logEvent("Weather API Error: " + err, "error");
                  fallbackToIP();
                });
            },
            error => {
              logEvent("Native Geolocation Error [code " + error.code + "]: " + error.message + ". Falling back to IP geolocation.", "error");
              fallbackToIP();
            },
            { timeout: 10000 }
          );
        } else {
          document.getElementById("weather").innerText = "Geolocation not supported";
          logEvent("Geolocation not supported by this browser.", "error");
          fallbackToIP();
        }
      }
      
      function fallbackToIP() {
        logEvent("Using IP-based geolocation (ip-api.com) as fallback.");
        fetch("https://ip-api.com/json/")
          .then(response => response.json())
          .then(data => {
            const city = data.city || "Unknown";
            logEvent("IP geolocation result: " + city);
            const url = `https://wttr.in/@${encodeURIComponent(city)}?format=j1`;
            logEvent("Querying weather for " + city + " using URL: " + url);
            return fetch(url)
              .then(response => response.json())
              .then(data => {
                const temp = data.current_condition[0].temp_C;
                const description = data.current_condition[0].weatherDesc[0].value;
                document.getElementById("weather").innerText = `${city} | ${temp}째C, ${description}`;
                logEvent("Weather updated via IP fallback: " + `${city} | ${temp}째C, ${description}`);
              });
          })
          .catch(err => {
            document.getElementById("weather").innerText = "Weather data unavailable";
            logEvent("IP Geolocation Error: " + err, "error");
          });
      }
    });
  </script>
</body>
</html>
